<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title></title>


    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

    <!--
    <script src="jquery-ui-1.11.3.custom/external/jquery/jquery.js"></script>
    <script src="jquery-ui-1.11.3.custom/jquery-ui.js"></script>
    <link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.min.css">
    <link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.theme.css">
-->

    <link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
    <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 75%;
            width: 75%;
            margin: 0;
            padding: 0;
        }

        h3 {
            margin: 0 0 5px 0;
            border-bottom: 1px solid #444;
        }

        .shadow {
            box-shadow: 0 0 5px #888;
        }

        #map {
            margin: 0;
            padding: 0;
        }

        #note,
        #hint {
            font-size: 80%;
        }

        #note {
            font-weight: 700;
            padding: 0 0 10px 0;
        }

        #layerList {
            width: 150px;
        }

        .dojoDndItemOver {
            background: #ccc;
        }
    </style>


    <style>
        #draggable {
            width: 150px;
            padding: 0.5em;
            position: absolute;
            top: 0;
            left: 0;
            background: #ffffff;
        }
    </style>

    <script src="http://js.arcgis.com/3.12/"></script>
    <script>
        // the infos object is used to track layer visibility and position
        var map, usaLayer, infos = {};
        var urlString;
        var layerUL;
        var serviceLayers = new Array();
        var fullLink;

        require([
        "esri/map", "esri/layers/ArcGISDynamicMapServiceLayer",
        "esri/layers/FeatureLayer",
        "esri/layers/DynamicLayerInfo", "esri/layers/LayerDataSource",
        "esri/layers/LayerDrawingOptions", "esri/layers/TableDataSource",
        "esri/Color", "esri/renderers/SimpleRenderer",
        "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
        "dojo/dom", "dojo/dom-construct", "dojo/dom-style",
        "dojo/query", "dojo/on",
        "dojo/parser", "dojo/_base/array", "dojo/dnd/Source",
        "dijit/registry",
        "esri/dijit/BasemapGallery", "esri/arcgis/utils",

        "dijit/form/Button",
        "dijit/layout/BorderContainer", "dijit/layout/ContentPane",
        "dijit/TitlePane",
        "dojo/domReady!"
    ], function (
            Map, ArcGISDynamicMapServiceLayer,
            FeatureLayer,
            DynamicLayerInfo, LayerDataSource,
            LayerDrawingOptions, TableDataSource,
            Color, SimpleRenderer,
            SimpleFillSymbol, SimpleLineSymbol,
            dom, domConstruct, domStyle,
            query, on,
            parser, arrayUtils, Source, registry,
            BasemapGallery, arcgisUtils
        ) {
            parser.parse();


            var allLayers = {};

            map = new Map("map", {
                basemap: "topo",
                center: [-95.339524, 29.003501], // long, lat
                zoom: 7,
                slider: false
            });



            //add the basemap gallery, in this case we'll display maps from ArcGIS.com including bing maps
            var basemapGallery = new BasemapGallery({
                showArcGISBasemaps: true,
                map: map
            }, "basemapGallery");
            basemapGallery.startup();

            basemapGallery.on("error", function (msg) {
                console.log("basemap gallery error:  ", msg);
            });
            //end basemap code





            var pathToRoot = "http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services?f=pjson";
            var folderLinks = [];
            var serviceFolderLinks = [];
            var currentList;
            var currentIndex;


            //function to build the layer list
            $(function () {
                var layers = $("#layersList");

                $.ajax({
                    url: pathToRoot,
                    type: "GET",
                    dataType: "json",
                    async: false,
                    success: function (data, status, jqXHR) {
                        var content = "";
                        content += "<ul>";
                        $.each(data.folders, function (key, item) {
                            var nextLevel = ("http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/" + item + "?f=pjson");
                            var folderNameLength = item.length;

                            if (item === "TA") {

                                //Copy from here
                                $.ajax({
                                    url: nextLevel,
                                    type: "GET",
                                    dataType: "json",
                                    async: false,
                                    success: function (data, status, jqXHR) {
                                        var data;

                                        content += "<li>" + item + "</li><ul link=" + item + ">";

                                        $.each(data.services, function (key, item2) {
                                            var subFolderName = item2.name;
                                            var nextLevel2 = ("http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/" + subFolderName + "/" + item2.type + "?f=pjson");


                                            $.ajax({
                                                url: nextLevel2,
                                                type: "GET",
                                                dataType: "json",
                                                async: false,
                                                success: function (data, status, jqXHR) {
                                                    var data;

                                                    content += "<li>" + subFolderName.substring(folderNameLength + 1, subFolderName.length) + "</li><ul link=" + subFolderName.substring(folderNameLength + 1, subFolderName.length) + ">";


                                                    $.each(data.layers, function (key, item2) {
                                                        var layerName = item2.name;
                                                        layerNameCode = encodeURIComponent(layerName);
                                                        content += "<li layerID=" + item2.id + "><input type='checkbox' name=\"" + layerNameCode + "\"><label for=\"" + layerNameCode + "\">" + layerName + "</label></li>";


                                                    });
                                                    content += "</ul>";


                                                }

                                            });

                                            //To here

                                        });
                                        content += "</ul>";
                                    }
                                });
                            }
                        });
                        content += "</ul>";
                        layers.append(content); //Appends the giant layer list (stored in content) to #layersList.
                        initHandler();
                    }
                });

            });


            function initHandler() {
                $("input[type='checkbox']").click(function () {
                    var layerName = decodeURIComponent(this.name);
                    var layerID = $(this).parent().attr('layerID');

                    var parentDir = $(this).parent().parent().attr('link'); //gets parent directory
                    var fullLayerID = parentDir + "_" + layerID;
                    var rootDir = $(this).parent().parent().parent().attr('link');
                    var baseDir = rootDir + "/" + parentDir + "/MapServer/" + layerID;
                    fullLink = "http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/" + baseDir;

                    if ($(this).is(":checked")) {

                        createLayer(fullLink, fullLayerID);
                    } else {

                        deleteLayer(fullLayerID);
                    }
                });
            }

            function createLayer(directory, layerName) {
                allLayers[layerName] = new FeatureLayer(directory, {
                    id: layerName
                });
                map.addLayer(allLayers[layerName]);
            }

            function deleteLayer(layerName) {
                map.removeLayer(allLayers[layerName]); //It will be something like this. Maybe use hide layer instead - look it up!
            }

        });
    </script>

    <!-- This makes the TOC draggable, but I don't want it to be.
<script>
      $(function() {
        $( "#draggable" ).draggable();
      });
</script>
-->

</head>

<body class="tundra">
    <div style="width: 100%; height: 100%; margin: 0;">
        <div id="map">
            <div style="position:absolute; right:20px; top:10px; z-Index:999;">
                <div data-dojo-type="dijit/TitlePane" data-dojo-props="title:'Switch Basemap', closable:false, open:false">
                    <div data-dojo-type="dijit/layout/ContentPane" style="width:380px; height:280px; overflow:auto;">
                        <div id="basemapGallery"></div>
                    </div>
                </div>
            </div>

        </div>


        <div>
            <p>
                This map does the following:
            </p>
            <ol>
                <li>
                    Gets all of the layes from a map server
                    <ul>
                        <li>
                            Allows you turn layers on and off
                        </li>
                        <li>
                            Allows you to reorder layers
                        </li>
                    </ul>
                </li>

            </ol>
        </div>
        <!--
        <div>
            <aside id="layerRough" style="float:right;"></aside>
        </div>

-->
        <div id="layersList">

        </div>
    </div>
</body>

</html>
