<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <!--The viewport meta tag is used to improve the presentation and behavior of the samples on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title></title>


    <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

    <!--
    <script src="jquery-ui-1.11.3.custom/external/jquery/jquery.js"></script>
    <script src="jquery-ui-1.11.3.custom/jquery-ui.js"></script>
    <link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.min.css">
    <link rel="stylesheet" href="jquery-ui-1.11.3.custom/jquery-ui.theme.css">
-->

    <link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
    <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 75%;
            width: 75%;
            margin: 0;
            padding: 0;
        }

        h3 {
            margin: 0 0 5px 0;
            border-bottom: 1px solid #444;
        }

        .shadow {
            box-shadow: 0 0 5px #888;
        }

        #map {
            margin: 0;
            padding: 0;
        }

        #note,
        #hint {
            font-size: 80%;
        }

        #note {
            font-weight: 700;
            padding: 0 0 10px 0;
        }

        #layerList {
            width: 150px;
        }

        .dojoDndItemOver {
            background: #ccc;
        }
    </style>


    <style>
        #draggable {
            width: 150px;
            padding: 0.5em;
            position: absolute;
            top: 0;
            left: 0;
            background: #ffffff;
        }
    </style>

    <script src="http://js.arcgis.com/3.12/"></script>
    <script>
        // the infos object is used to track layer visibility and position
        var map, usaLayer, infos = {};
        var urlString;
        var layerUL;
        var serviceLayers = new Array();
        var fullLink;

        require([
        "esri/map", "esri/layers/ArcGISDynamicMapServiceLayer",
        "esri/layers/DynamicLayerInfo", "esri/layers/LayerDataSource",
        "esri/layers/LayerDrawingOptions", "esri/layers/TableDataSource",
        "esri/Color", "esri/renderers/SimpleRenderer",
        "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
        "dojo/dom", "dojo/dom-construct", "dojo/dom-style",
        "dojo/query", "dojo/on",
        "dojo/parser", "dojo/_base/array", "dojo/dnd/Source",
        "dijit/registry",
        "esri/dijit/BasemapGallery", "esri/arcgis/utils",

        "dijit/form/Button",
        "dijit/layout/BorderContainer", "dijit/layout/ContentPane",
        "dijit/TitlePane",
        "dojo/domReady!"
    ], function (
            Map, ArcGISDynamicMapServiceLayer,
            DynamicLayerInfo, LayerDataSource,
            LayerDrawingOptions, TableDataSource,
            Color, SimpleRenderer,
            SimpleFillSymbol, SimpleLineSymbol,
            dom, domConstruct, domStyle,
            query, on,
            parser, arrayUtils, Source, registry,
            BasemapGallery, arcgisUtils
        ) {
            parser.parse();

            var dynamicLayerInfos;


            map = new Map("map", {
                basemap: "topo",
                center: [-95.339524, 29.003501], // long, lat
                zoom: 7,
                slider: false
            });

            var dndSource = new Source("layerList");
            dndSource.on("DndDrop", reorderLayers);
            //
            //                        usaLayer = new ArcGISDynamicMapServiceLayer("http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/CA/CA14_HWinds_Historic/MapServer", {
            //                            "id": "usa"
            //                        });
            //                        usaLayer.on("load", function (e) {
            //                            dynamicLayerInfos = e.target.createDynamicLayerInfosFromLayerInfos();
            //                            arrayUtils.forEach(dynamicLayerInfos, function (info) {
            //                                var i = {
            //                                    id: info.id,
            //                                    name: info.name,
            //                                    position: info.id
            //                                };
            //                                if (arrayUtils.indexOf(usaLayer.visibleLayers, info.id) > -1) {
            //                                    i.visible = true;
            //                                } else {
            //                                    i.visible = false;
            //                                }
            //                                infos[info.id] = i;
            //                            });
            //                            infos.total = dynamicLayerInfos.length;
            //                            e.target.setDynamicLayerInfos(dynamicLayerInfos, true);
            //                        });

            //            /*function layerLoad(e) {
            //              dynamicLayerInfos = e.target.createDynamicLayerInfosFromLayerInfos();
            //              arrayUtils.forEach(dynamicLayerInfos, function(info) {
            //                var i = {
            //                  id: info.id,
            //                  name: info.name,
            //                  position: info.id
            //                };
            //                if (arrayUtils.indexOf(usaLayer.visibleLayers, info.id) > -1) {
            //                  i.visible = true;
            //                }
            //                else {
            //                  i.visible = false;
            //                }
            //                infos[info.id] = i;
            //              });
            //              infos.total = dynamicLayerInfos.length;
            //              e.target.setDynamicLayerInfos(dynamicLayerInfos, true);
            //            }*/

            // only create the layer list the first time update-end fires
            //                        on.once(usaLayer, "update-end", buildLayerList);
            // hide the loading icon when the dynamic layer finishes updating
            //                        usaLayer.on("update-end", hideLoading);
            //                        map.addLayer(usaLayer);

            function buildLayerList() {
                dndSource.clearItems();
                domConstruct.empty(dom.byId("layerList"));

                var layerNames = [];
                for (var info in infos) {
                    if (!infos[info].hasOwnProperty("id")) {
                        continue;
                    }
                    // only want the layer's name, don't need the db name and owner name
                    var nameParts = infos[info].name.split(".");
                    var layerName = nameParts[nameParts.length - 1];
                    var layerDiv = createToggle(layerName, infos[info].visible);
                    layerNames[infos[info].position] = layerDiv;
                }

                dndSource.insertNodes(false, layerNames);
            }

            function toggleLayer(e) {
                showLoading();
                for (var info in infos) {
                    var i = infos[info];
                    if (i.name === e.target.name) {
                        i.visible = !i.visible;
                    }
                }
                usaLayer.setDynamicLayerInfos(getVisibleLayers());
                if (visible.length === 0) {
                    usaLayer.setVisibleLayers([-1]);
                } else {
                    usaLayer.setDynamicLayerInfos(visible);
                }
            }

            function reorderLayers() {
                showLoading();
                var newOrder = getVisibleLayers();

                usaLayer.setDynamicLayerInfos(newOrder);
            }



            function getVisibleLayers() {
                // get layer name nodes, build an array corresponding to new layer order
                var layerOrder = [];
                query("#layerList .dojoDndItem label").forEach(function (n, idx) {
                    for (var info in infos) {
                        var i = infos[info];
                        if (i.name === n.innerHTML) {
                            layerOrder[idx] = i.id;
                            // keep track of a layer's position in the layer list
                            i.position = idx;
                            break;
                        }
                    }
                });
                // find the layer IDs for visible layer
                var ids = arrayUtils.filter(layerOrder, function (l) {
                    return infos[l].visible;
                });
                // get the dynamicLayerInfos for visible layers
                var visible = arrayUtils.map(ids, function (id) {
                    return dynamicLayerInfos[id];
                });
                return visible;
            }

            function createToggle(name, visible) {
                var div = domConstruct.create("div");
                var layerVis = domConstruct.create("input", {
                    checked: visible,
                    id: name,
                    name: name,
                    type: "checkbox"
                }, div);
                on(layerVis, "click", toggleLayer);
                var layerSpan = domConstruct.create("label", {
                    for: name,
                    innerHTML: name
                }, div);
                return div;
            }

            function showLoading() {
                domStyle.set(dom.byId("loading"), "display", "inline-block");
            }

            function hideLoading() {
                domStyle.set(dom.byId("loading"), "display", "none");
            }

            //add the basemap gallery, in this case we'll display maps from ArcGIS.com including bing maps
            var basemapGallery = new BasemapGallery({
                showArcGISBasemaps: true,
                map: map
            }, "basemapGallery");
            basemapGallery.startup();

            basemapGallery.on("error", function (msg) {
                console.log("basemap gallery error:  ", msg);
            });
            //end basemap code


            function addLayer(data) {

                /*var checkedLayer = new ArcGISDynamicMapServiceLayer(fullLink, {
                    "id": data,
                    "opacity": 0.75
                });*/

                //map.addLayer(checkedLayer);
                var statesUrl = "http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/TA/TA_AdminBdys/MapServer/7";
                var states = new FeatureLayer(statesUrl, {
                    id: data
                        //outFields: [labelField]
                });
                map.addLayer(states);
            }

            //        $.getJSON("http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services?f=pjson", getFolders);

            var pathToRoot = "http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services?f=pjson";
            var folderLinks = [];
            var serviceFolderLinks = [];
            var currentList;
            var currentIndex;


            //function to build the layer list
            $(function () {
                var layers = $("#layersList");

                $.ajax({
                    url: pathToRoot,
                    type: "GET",
                    dataType: "json",
                    async: false,
                    success: function (data, status, jqXHR) {
                        var content = "";
                        content += "<ul>";
                        $.each(data.folders, function (key, item) {
                            var nextLevel = ("http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/" + item + "?f=pjson");
                            var folderNameLength = item.length;

                            if (item === "TA") {

                                //Copy from here
                                $.ajax({
                                    url: nextLevel,
                                    type: "GET",
                                    dataType: "json",
                                    async: false,
                                    success: function (data, status, jqXHR) {
                                        var data;

                                        content += "<li>" + item + "</li><ul link=" + item + ">";

                                        $.each(data.services, function (key, item2) {
                                            var subFolderName = item2.name;
                                            var nextLevel2 = ("http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/" + subFolderName + "/" + item2.type + "?f=pjson");


                                            $.ajax({
                                                url: nextLevel2,
                                                type: "GET",
                                                dataType: "json",
                                                async: false,
                                                success: function (data, status, jqXHR) {
                                                    var data;
                                                    //content += "<ul>";
                                                    content += "<li>" + subFolderName.substring(folderNameLength + 1, subFolderName.length) + "</li><ul link=" + subFolderName.substring(folderNameLength + 1, subFolderName.length) + ">";


                                                    $.each(data.layers, function (key, item2) {
                                                        var layerName = item2.name;
                                                        content += "<li layerID=" + item2.id + "><input type='checkbox' name=" + layerName + "><label for=" + layerName + ">" + layerName + "</label></li>";
                                                        //content += "<li>" + layerName.substring(folderNameLength + 1, layerName.length - 1) + "</li>";

                                                    });
                                                    content += "</ul>";


                                                }

                                            });

                                            //To here

                                        });
                                        content += "</ul>";
                                    }
                                });
                            }
                        });
                        content += "</ul>";
                        layers.append(content); //Appends the giant layer list (stored in content) to #layersList.
                        initHandlder();
                    }
                });

            });

            //work on this part!
            function initHandlder() {
                $("input[type='checkbox']").click(function () {
                    if ($(this).is(":checked")) {
                        var layerID = $(this).parent().attr('layerID');
                        var parentDir = $(this).parent().parent().attr('link'); //gets parent directory
                        var rootDir = $(this).parent().parent().parent().attr('link');
                        var baseDir = rootDir + "/" + parentDir + "/MapServer/" + layerID;
                        fullLink = "http://texasatlas.arch.tamu.edu:6080/arcgis/rest/services/" + baseDir;
                        var dummy;
                        addLayer(parentDir);
                    } else {
                        console.log("nothing here");
                    }
                });
            }
        });
    </script>

    <!-- This makes the TOC draggable, but I don't want it to be.
<script>
      $(function() {
        $( "#draggable" ).draggable();
      });
</script>
-->

</head>

<body class="tundra">
    <div style="width: 100%; height: 100%; margin: 0;">
        <div id="map">
            <div style="position:absolute; right:20px; top:10px; z-Index:999;">
                <div data-dojo-type="dijit/TitlePane" data-dojo-props="title:'Switch Basemap', closable:false, open:false">
                    <div data-dojo-type="dijit/layout/ContentPane" style="width:380px; height:280px; overflow:auto;">
                        <div id="basemapGallery"></div>
                    </div>
                </div>
            </div>

        </div>

        <!--   Start of Table of Contents     -->
        <div id="draggable" class="shadow">
            <h3>Add and Re-order Layers</h3>
            <div id="info">
                <div id="note">
                    Note: This sample requires an ArcGIS Server version 10.1 or later map service.
                </div>

                <div id="hint">
                    Click and drag a map layer name below to re-order layers. The first layer in the list will be drawn on top.
                </div>

                <strong>Map Layers</strong>
                <img id="loading" src="https://dl.dropboxusercontent.com/u/2654618/loading_black.gif">
                <br>
                <div id="layerList"></div>

            </div>
        </div>
        <!--  End Table of Contents          -->
        <div>
            <p>
                This map does the following:
            </p>
            <ol>
                <li>
                    Gets all of the layes from a map server
                    <ul>
                        <li>
                            Allows you turn layers on and off
                        </li>
                        <li>
                            Allows you to reorder layers
                        </li>
                    </ul>
                </li>

            </ol>
        </div>
        <!--
        <div>
            <aside id="layerRough" style="float:right;"></aside>
        </div>

-->
        <div id="layersList">

        </div>
    </div>
</body>

</html>
